!!!RESOLVE EWI!!! /*** SSC-EWI-0040 - THE STATEMENT IS NOT SUPPORTED IN SNOWFLAKE ***/!!!
.RUN FILE=%%BTEQ_LOGON_SCRIPT%%

!!!RESOLVE EWI!!! /*** SSC-EWI-0040 - THE STATEMENT IS NOT SUPPORTED IN SNOWFLAKE ***/!!!
.IF ERRORCODE <> 0 THEN .GOTO EXITERR

!!!RESOLVE EWI!!! /*** SSC-EWI-0040 - THE STATEMENT IS NOT SUPPORTED IN SNOWFLAKE ***/!!!

.SET QUIET OFF

!!!RESOLVE EWI!!! /*** SSC-EWI-0040 - THE STATEMENT IS NOT SUPPORTED IN SNOWFLAKE ***/!!!
.SET ECHOREQ ON

!!!RESOLVE EWI!!! /*** SSC-EWI-0040 - THE STATEMENT IS NOT SUPPORTED IN SNOWFLAKE ***/!!!
.SET FORMAT OFF

!!!RESOLVE EWI!!! /*** SSC-EWI-0040 - THE STATEMENT IS NOT SUPPORTED IN SNOWFLAKE ***/!!!
.SET WIDTH 120
----------------------------------------------------------------------
-- $LastChangedBy: vajapes $
-- $LastChangedDate: 2012-05-03 14:09:15 +1000 (Thu, 03 May 2012) $
-- $LastChangedRevision: 9596 $
----------------------------------------------------------------------
------------------------------------------------------------------------------
--
--  Description :Reconciliation process
--
--   Ver  Date       Modified By            Description
--  ---- ---------- ---------------------- -----------------------------------
--  1.0  2011-10-05 Suresh Vajapeyajula               Initial Version
------------------------------------------------------------------------------

/*Delete previous run data from ACCT_BALN_BKDT_RECN*/
DELETE;
-- ** SSC-EWI-0001 - UNRECOGNIZED TOKEN ON LINE '23' COLUMN '7' OF THE SOURCE CODE STARTING AT '%'. EXPECTED 'STATEMENT' GRAMMAR. LAST MATCHING TOKEN WAS '120' ON LINE '7' COLUMN '12'. FAILED TOKEN WAS '%' ON LINE '23' COLUMN '7'. **
--        %%CAD_PROD_DATA%%.ACCT_BALN_BKDT_RECN
                                             ;

!!!RESOLVE EWI!!! /*** SSC-EWI-0040 - THE STATEMENT IS NOT SUPPORTED IN SNOWFLAKE ***/!!!

.IF ERRORCODE <> 0 THEN .GOTO EXITERR

-- ** SSC-EWI-0001 - UNRECOGNIZED TOKEN ON LINE '28' COLUMN '0' OF THE SOURCE CODE STARTING AT 'INSERT'. EXPECTED 'Insert' GRAMMAR. LAST MATCHING TOKEN WAS 'INTO' ON LINE '28' COLUMN '7'. **
--/*Insert data into ACCT_BALN_BKDT_RECN table*/
--INSERT INTO %%CAD_PROD_DATA%%.ACCT_BALN_BKDT_RECN
--SELECT
--DT.ACCT_I
--,BAL.EFFT_D
--,BAL.EXPY_D
--,DT.BALN_A
--,NULL AS PROS_KEY_EFFT_I
--FROM
--(
--SELECT
--B.ACCT_I,
--B.BALN_A
--FROM
--/*Qualifying only those records that are considered for applying adjustments as part of this run*/
--%%DDSTG%%.ACCT_BALN_BKDT_STG2 A
--INNER JOIN
--%%VTECH%%.ACCT_BALN B
--ON
--A.ACCT_I=B.ACCT_I
--WHERE
--B.BALN_TYPE_C='BALN'
--AND B.CALC_FUNC_C='SPOT'
--AND B.TIME_PERD_C = 'E'
--/*reconciling the balances only for the current record*/
--AND CURRENT_DATE BETWEEN B.EFFT_D AND B.EXPY_D

--MINUS

--SELECT
--STG.ACCT_I,
--(CASE WHEN STG.BKDT_EFFT_D > BKDT.BKDT_EFFT_D  THEN STG.BALN_A
--ELSE BKDT.BALN_A END ) AS BALN_A
--FROM
--(
--SELECT
--A.ACCT_I
--,A.BKDT_EFFT_D
--,A.BKDT_EXPY_D
--,A.BALN_A
--FROM
--%%DDSTG%%.ACCT_BALN_BKDT_STG2 A
--WHERE
--A.BALN_TYPE_C='BDCL'
--AND A.CALC_FUNC_C='SPOT'
--AND A.TIME_PERD_C = 'E'
--AND CURRENT_DATE BETWEEN A.BKDT_EFFT_D AND A.BKDT_EXPY_D
--)STG
--INNER JOIN
--(
--SELECT
--B.ACCT_I
--,B.BKDT_EFFT_D
--,B.BKDT_EXPY_D
--,B.BALN_A
--FROM
--%%DDSTG%%.ACCT_BALN_BKDT_STG2 A
--INNER JOIN
--%%VTECH%%.ACCT_BALN_BKDT B
--ON
--A.ACCT_I = B.ACCT_I
--WHERE
--B.BALN_TYPE_C='BDCL'
--AND B.CALC_FUNC_C='SPOT'
--AND B.TIME_PERD_C = 'E'
--AND CURRENT_DATE BETWEEN B.BKDT_EFFT_D AND B.BKDT_EXPY_D
--)BKDT
--ON
--STG.ACCT_I = BKDT.ACCT_I
--)DT
--INNER JOIN
--%%VTECH%%.ACCT_BALN BAL
--ON
--DT.ACCT_I = BAL.ACCT_I
--WHERE
--BAL.BALN_TYPE_C='BDCL'
--AND BAL.CALC_FUNC_C='SPOT'
--AND BAL.TIME_PERD_C = 'E'
--AND CURRENT_DATE BETWEEN BAL.EFFT_D AND BAL.EXPY_D
;

!!!RESOLVE EWI!!! /*** SSC-EWI-0040 - THE STATEMENT IS NOT SUPPORTED IN SNOWFLAKE ***/!!!

.IF ACTIVITYCOUNT<>0 THEN .GOTO ERR_SEV

!!!RESOLVE EWI!!! /*** SSC-EWI-0040 - THE STATEMENT IS NOT SUPPORTED IN SNOWFLAKE ***/!!!


.IF ERRORCODE <> 0 THEN .GOTO EXITERR


-- ** SSC-EWI-0001 - UNRECOGNIZED TOKEN ON LINE '114' COLUMN '0' OF THE SOURCE CODE STARTING AT 'INSERT'. EXPECTED 'Insert' GRAMMAR. LAST MATCHING TOKEN WAS 'INTO' ON LINE '114' COLUMN '7'. **
--INSERT INTO %%CAD_PROD_DATA%%.ACCT_BALN_BKDT_RECN
--SELECT
-- DT1.ACCT_I
--,STG.BKDT_EFFT_D
--,STG.BKDT_EXPY_D
--,STG.BALN_A
--,NULL AS PROS_KEY_EFFT_I
--FROM
--(SELECT
--STG.ACCT_I,
--(CASE WHEN STG.BKDT_EFFT_D > BKDT.BKDT_EFFT_D  THEN STG.BALN_A
--ELSE BKDT.BALN_A END ) AS BALN_A,
--NULL AS PROS_KEY_EFFT_I
--FROM
--(
--SELECT
--A.ACCT_I
--,A.BKDT_EFFT_D
--,A.BKDT_EXPY_D
--,A.BALN_A
--FROM
--%%DDSTG%%.ACCT_BALN_BKDT_STG2 A
--WHERE
--A.BALN_TYPE_C='BDCL'
--AND A.CALC_FUNC_C='SPOT'
--AND A.TIME_PERD_C = 'E'
--AND CURRENT_DATE BETWEEN A.BKDT_EFFT_D AND A.BKDT_EXPY_D
--)STG
--INNER JOIN
--(
--SELECT
--B.ACCT_I
--,B.BKDT_EFFT_D
--,B.BKDT_EXPY_D
--,B.BALN_A
--FROM
--%%DDSTG%%.ACCT_BALN_BKDT_STG2 A
--INNER JOIN
--%%VTECH%%.ACCT_BALN_BKDT B
--ON
--A.ACCT_I = B.ACCT_I
--WHERE
--B.BALN_TYPE_C='BDCL'
--AND B.CALC_FUNC_C='SPOT'
--AND B.TIME_PERD_C = 'E'
--AND CURRENT_DATE BETWEEN B.BKDT_EFFT_D AND B.BKDT_EXPY_D
--)BKDT
--ON
--STG.ACCT_I = BKDT.ACCT_I

--MINUS

--SELECT
--B.ACCT_I,
--B.BALN_A,
--NULL AS PROS_KEY_EFFT_I
--FROM
--/*Qualifying only those records that are considered for applying adjustments as part of this run*/
--%%DDSTG%%.ACCT_BALN_BKDT_STG2 A
--INNER JOIN
--%%VTECH%%.ACCT_BALN B
--ON
--A.ACCT_I=B.ACCT_I
--WHERE
--B.BALN_TYPE_C='BALN'
--AND B.CALC_FUNC_C='SPOT'
--AND B.TIME_PERD_C = 'E'
--/*reconciling the balances only for the current record*/
--AND CURRENT_DATE BETWEEN B.EFFT_D AND B.EXPY_D
--)DT1
--INNER JOIN
--%%DDSTG%%.ACCT_BALN_BKDT_STG2 STG
--ON
--DT1.ACCT_I=STG.ACCT_I
--AND CURRENT_DATE BETWEEN STG.BKDT_EFFT_D AND STG.BKDT_EXPY_D
;


/*Activity Count > 0 implies - An adjustment affecting the balances of an open record for 
the ACCT_I loaded into ACCT_BALN_BKDT_RECN table.This impacts the next daily delta 
load of Datastage. Thereby it is highly recommended to fix the issue 
before you restart in such a failures*/!!!RESOLVE EWI!!! /*** SSC-EWI-0040 - THE STATEMENT IS NOT SUPPORTED IN SNOWFLAKE ***/!!!

.IF ACTIVITYCOUNT<>0 THEN .GOTO ERR_SEV

!!!RESOLVE EWI!!! /*** SSC-EWI-0040 - THE STATEMENT IS NOT SUPPORTED IN SNOWFLAKE ***/!!!

.IF ERRORCODE <> 0 THEN .GOTO EXITERR

-- ** SSC-EWI-0001 - UNRECOGNIZED TOKEN ON LINE '202' COLUMN '0' OF THE SOURCE CODE STARTING AT 'UPDATE'. EXPECTED 'Update' GRAMMAR. LAST MATCHING TOKEN WAS 'UPDATE' ON LINE '202' COLUMN '0'. FAILED TOKEN WAS '%' ON LINE '202' COLUMN '7'. **
--/*Update the flags,counts for the process in UTIl_PROS_ISAC*/
--UPDATE %%CAD_PROD_DATA%%.UTIL_PROS_ISAC
--FROM
--(SELECT COUNT(*) FROM
--%%VTECH%%.ACCT_BALN_BKDT_RECN)A(INS_CNT)
--SET     COMT_F = 'Y',
--	SUCC_F='Y',
--	COMT_S =  CURRENT_TIMESTAMP(0),
--	SYST_INS_Q = A.INS_CNT
-- WHERE PROS_KEY_I = (SELECT MAX(PROS_KEY_I) FROM %%VTECH%%.UTIL_PROS_ISAC
-- WHERE CONV_M='CAD_X01_ACCT_BALN_BKDT_RECN')
                                             ;

 !!!RESOLVE EWI!!! /*** SSC-EWI-0040 - THE STATEMENT IS NOT SUPPORTED IN SNOWFLAKE ***/!!!

.IF ERRORCODE <> 0 THEN .GOTO EXITERR

!!!RESOLVE EWI!!! /*** SSC-EWI-0040 - THE STATEMENT IS NOT SUPPORTED IN SNOWFLAKE ***/!!!

.QUIT 0

!!!RESOLVE EWI!!! /*** SSC-EWI-0040 - THE STATEMENT IS NOT SUPPORTED IN SNOWFLAKE ***/!!!
.LOGOFF

!!!RESOLVE EWI!!! /*** SSC-EWI-0040 - THE STATEMENT IS NOT SUPPORTED IN SNOWFLAKE ***/!!!
.EXIT

!!!RESOLVE EWI!!! /*** SSC-EWI-0040 - THE STATEMENT IS NOT SUPPORTED IN SNOWFLAKE ***/!!!

.LABEL EXITERR

!!!RESOLVE EWI!!! /*** SSC-EWI-0040 - THE STATEMENT IS NOT SUPPORTED IN SNOWFLAKE ***/!!!
.QUIT 1

!!!RESOLVE EWI!!! /*** SSC-EWI-0040 - THE STATEMENT IS NOT SUPPORTED IN SNOWFLAKE ***/!!!
.LOGOFF

!!!RESOLVE EWI!!! /*** SSC-EWI-0040 - THE STATEMENT IS NOT SUPPORTED IN SNOWFLAKE ***/!!!
.EXIT

!!!RESOLVE EWI!!! /*** SSC-EWI-0040 - THE STATEMENT IS NOT SUPPORTED IN SNOWFLAKE ***/!!!


.LABEL ERR_SEV

-- ** SSC-EWI-0001 - UNRECOGNIZED TOKEN ON LINE '228' COLUMN '0' OF THE SOURCE CODE STARTING AT 'UPDATE'. EXPECTED 'Update' GRAMMAR. LAST MATCHING TOKEN WAS 'UPDATE' ON LINE '228' COLUMN '0'. FAILED TOKEN WAS '%' ON LINE '228' COLUMN '7'. **
--/*Updating the records with the latest pros key */
--UPDATE %%CAD_PROD_DATA%%.ACCT_BALN_BKDT_RECN
--FROM
--(SELECT MAX(PROS_KEY_I) AS PROS_KEY_I
--FROM %%VTECH%%.UTIL_PROS_ISAC
--WHERE CONV_M= 'CAD_X01_ACCT_BALN_BKDT_RECN') D (PROS_KEY_I)
--SET PROS_KEY_EFFT_I = D.PROS_KEY_I
                                  ;

!!!RESOLVE EWI!!! /*** SSC-EWI-0040 - THE STATEMENT IS NOT SUPPORTED IN SNOWFLAKE ***/!!!

.QUIT 1

!!!RESOLVE EWI!!! /*** SSC-EWI-0040 - THE STATEMENT IS NOT SUPPORTED IN SNOWFLAKE ***/!!!
.LOGOFF

!!!RESOLVE EWI!!! /*** SSC-EWI-0040 - THE STATEMENT IS NOT SUPPORTED IN SNOWFLAKE ***/!!!
.EXIT
# LLM Response
Interaction ID: 20250821_154536_a22080e5
Success: True
Processing Time: 18619ms
Quality Score: None

# Response
```sql
{%- set process_name = 'ACCT_BALN_BKDT_PROS_KEY' -%}
{%- set stream_name = 'ACCT_BALN_BKDT' -%}

{{
  config(
    materialized='table',
    database=var('target_database'),
    schema=var('target_schema'),
    tags=['ACCT_BALN_BKDT', 'PROS_KEY'],
    pre_hook=[
        "{{ log_dcf_exec_msg('Process started') }}"
    ],
    post_hook=[
        "{{ log_dcf_exec_msg('Process ended') }}"
    ]
  )
}}

/*
    Model Documentation
    Purpose: Capture the PROS Key and update in UTIL PROS ISAC
    Business Logic: 
        1. Capture the Latest Pros Key from UTIL PARM table and update UTIL PROS ISAC.
        2. Increment PROS KEY by 1 and update UTIL PARM table.
    Dependencies: 
        - UTIL_PARM table
        - UTIL_PROS_ISAC table
        - GRD_RPRT_CALR_CLYR table
*/

WITH latest_batch_date AS (
    SELECT 
        MAX(CASE WHEN TRGT_M='ACCT_BALN_ADJ' AND SRCE_SYST_M='SAP' AND COMT_F = 'Y' AND SUCC_F='Y' THEN BTCH_RUN_D END) AS BALN_BTCH_RUN_D,
        MAX(CASE WHEN TRGT_M='ACCT_BALN_BKDT' AND SRCE_SYST_M='GDW' AND COMT_F = 'Y' AND SUCC_F='Y' THEN BTCH_RUN_D END) AS BKDT_BTCH_RUN_D
    FROM 
        {{ source('UTIL_PROS_ISAC') }}
),

batch_run_dates AS (
    SELECT 
        CALR_CALR_D
    FROM 
        {{ source('GRD_RPRT_CALR_CLYR') }}
    WHERE 
        CALR_CALR_D > (SELECT BKDT_BTCH_RUN_D FROM latest_batch_date)
        AND CALR_CALR_D <= (SELECT BALN_BTCH_RUN_D FROM latest_batch_date)
),

pros_key AS (
    SELECT 
        PARM_LTRL_N + 1 AS PROS_KEY_I,
        'CAD_X01_ACCT_BALN_BKDT' AS CONV_M,
        'TD' AS CONV_TYPE_M,
        CURRENT_TIMESTAMP(0) AS PROS_RQST_S,
        CURRENT_TIMESTAMP(0) AS PROS_LAST_RQST_S,
        1 AS PROS_RQST_Q,
        CALR_CALR_D AS BTCH_RUN_D,
        NULL AS BTCH_KEY_I,
        'GDW' AS SRCE_SYST_M,
        'ACCT_BALN_BKDT_ADJ' AS SRCE_M,
        'ACCT_BALN_BKDT' AS TRGT_M,
        'N' AS SUCC_F,
        'N' AS COMT_F,
        NULL AS COMT_S,
        NULL AS MLTI_LOAD_EFFT_D,
        NULL AS SYST_S,
        NULL AS MLTI_LOAD_COMT_S,
        NULL AS SYST_ET_Q,
        NULL AS SYST_UV_Q,
        NULL AS SYST_INS_Q,
        NULL AS SYST_UPD_Q,
        NULL AS SYST_DEL_Q,
        NULL AS SYST_ET_TABL_M,
        NULL AS SYST_UV_TABL_M,
        NULL AS SYST_HEAD_ET_TABL_M,
        NULL AS SYST_HEAD_UV_TABL_M,
        NULL AS SYST_TRLR_ET_TABL_M,
        NULL AS SYST_TRLR_UV_TABL_M,
        NULL AS PREV_PROS_KEY_I,
        NULL AS HEAD_RECD_TYPE_C,
        NULL AS HEAD_FILE_M,
        NULL AS HEAD_BTCH_RUN_D,
        NULL AS HEAD_FILE_CRAT_S,
        NULL AS HEAD_GENR_PRGM_M,
        NULL AS HEAD_BTCH_KEY_I,
        NULL AS HEAD_PROS_KEY_I,
        NULL AS HEAD_PROS_PREV_KEY_I,
        NULL AS TRLR_RECD_TYPE_C,
        NULL AS TRLR_RECD_Q,
        NULL AS TRLR_HASH_TOTL_A,
        NULL AS TRLR_COLM_HASH_TOTL_M,
        NULL AS TRLR_EROR_RECD_Q,
        NULL AS TRLR_FILE_COMT_S,
        NULL AS TRLR_RECD_ISRT_Q,
        NULL AS TRLR_RECD_UPDT_Q,
        NULL AS TRLR_RECD_DELT_Q
    FROM 
        {{ source('UTIL_PARM') }} PARM
    CROSS JOIN 
        batch_run_dates
    WHERE 
        PARM.PARM_M = 'PROS_KEY'
),

updated_pros_key AS (
    SELECT 
        PROS_KEY_I,
        CONV_M,
        CONV_TYPE_M,
        PROS_RQST_S,
        PROS_LAST_RQST_S,
        PROS_RQST_Q,
        BTCH_RUN_D,
        BTCH_KEY_I,
        SRCE_SYST_M,
        SRCE_M,
        TRGT_M,
        SUCC_F,
        COMT_F,
        COMT_S,
        MLTI_LOAD_EFFT_D,
        SYST_S,
        MLTI_LOAD_COMT_S,
        SYST_ET_Q,
        SYST_UV_Q,
        SYST_INS_Q,
        SYST_UPD_Q,
        SYST_DEL_Q,
        SYST_ET_TABL_M,
        SYST_UV_TABL_M,
        SYST_HEAD_ET_TABL_M,
        SYST_HEAD_UV_TABL_M,
        SYST_TRLR_ET_TABL_M,
        SYST_TRLR_UV_TABL_M,
        PREV_PROS_KEY_I,
        HEAD_RECD_TYPE_C,
        HEAD_FILE_M,
        HEAD_BTCH_RUN_D,
        HEAD_FILE_CRAT_S,
        HEAD_GENR_PRGM_M,
        HEAD_BTCH_KEY_I,
        HEAD_PROS_KEY_I,
        HEAD_PROS_PREV_KEY_I,
        TRLR_RECD_TYPE_C,
        TRLR_RECD_Q,
        TRLR_HASH_TOTL_A,
        TRLR_COLM_HASH_TOTL_M,
        TRLR_EROR_RECD_Q,
        TRLR_FILE_COMT_S,
        TRLR_RECD_ISRT_Q,
        TRLR_RECD_UPDT_Q,
        TRLR_RECD_DELT_Q
    FROM 
        pros_key
)

SELECT * 
FROM 
    updated_pros_key
```
{
  "success": false,
  "quality_score": 1.0,
  "model_sql": "{%- set process_name = 'ACCT_BALN_BKDT_AUDT_GET_PROS_KEY' -%}\n{%- set stream_name = 'UTIL_PROS_ISAC' -%}\n\n{{\n  config(\n    materialized='table',\n    database=var('cad_prod_data'),\n    schema='default',\n    tags=['util', 'pros_key', 'audit'],\n    pre_hook=[\n        \"{{ log_dcf_exec_msg('ACCT_BALN_BKDT_AUDT_GET_PROS_KEY Process started') }}\"\n    ],\n    post_hook=[\n        \"{{ log_dcf_exec_msg('ACCT_BALN_BKDT_AUDT_GET_PROS_KEY Process ended') }}\",\n        \"UPDATE {{ var('cad_prod_data') }}.UTIL_PARM SET PARM_LTRL_N = PARM_LTRL_N + 1 WHERE PARM_M='PROS_KEY'\"\n    ]\n  )\n}}\n\n/*\n    Model: ACCT_BALN_BKDT_AUDT_GET_PROS_KEY\n    Purpose: Populate the AUDT table for future reference as the records \n             are going to be deleted from ACCT BALN BKDT and this acts as a driver for the \n             ADJ RULE view\n    Business Logic: \n        - Capture the Latest Pros Key from UTIL PARM table and update UTIL PROS ISAC\n        - Insert records for each batch run date between last successful and current batch runs\n        - Increment PROS_KEY by 1 in UTIL_PARM table\n    Dependencies: UTIL_PARM, UTIL_PROS_ISAC, GRD_RPRT_CALR_CLYR\n*/\n\nWITH util_parm AS (\n    SELECT \n        PARM_LTRL_N\n    FROM {{ var('vtech') }}.UTIL_PARM\n    WHERE PARM_M = 'PROS_KEY'\n),\n\nbkdt_prev AS (\n    -- Capture last Successful Batch run date relating to the Backdated adjustment solution\n    SELECT MAX(BTCH_RUN_D) AS BTCH_RUN_D \n    FROM {{ var('vtech') }}.UTIL_PROS_ISAC\n    WHERE TRGT_M = 'ACCT_BALN_BKDT' \n        AND SRCE_SYST_M = 'GDW'\n        AND COMT_F = 'Y'  \n        AND SUCC_F = 'Y'\n),\n\nbkdt_curr AS (\n    -- Capture latest Batch run date relating to the Backdated adjustment solution into ACCT_BALN_BKDT\n    SELECT MAX(BTCH_RUN_D) AS BTCH_RUN_D \n    FROM {{ var('vtech') }}.UTIL_PROS_ISAC\n    WHERE TRGT_M = 'ACCT_BALN_BKDT' \n        AND SRCE_SYST_M = 'GDW'\n),\n\ncalendar_dates AS (\n    -- Get calendar dates between previous and current batch run dates\n    SELECT CAL.CALR_CALR_D\n    FROM {{ var('vtech') }}.GRD_RPRT_CALR_CLYR CAL\n    CROSS JOIN bkdt_prev\n    CROSS JOIN bkdt_curr\n    WHERE CAL.CALR_CALR_D > bkdt_prev.BTCH_RUN_D \n        AND CAL.CALR_CALR_D <= bkdt_curr.BTCH_RUN_D\n),\n\nfinal AS (\n    SELECT \n        PARM.PARM_LTRL_N + 1 AS PROS_KEY_I,\n        'CAD_X01_ACCT_BALN_BKDT_AUDT' AS CONV_M,\n        'TD' AS CONV_TYPE_M,\n        CURRENT_TIMESTAMP(0) AS PROS_RQST_S,\n        CURRENT_TIMESTAMP(0) AS PROS_LAST_RQST_S,\n        1 AS PROS_RQST_Q,\n        DT.CALR_CALR_D AS BTCH_RUN_D,\n        NULL AS BTCH_KEY_I,\n        'GDW' AS SRCE_SYST_M,\n        'ACCT_BALN_BKDT' AS SRCE_M,\n        'ACCT_BALN_BKDT_AUDT' AS TRGT_M,\n        'N' AS SUCC_F,\n        'N' AS COMT_F,\n        NULL AS COMT_S,\n        NULL AS MLTI_LOAD_EFFT_D,\n        NULL AS SYST_S,\n        NULL AS MLTI_LOAD_COMT_S,\n        NULL AS SYST_ET_Q,\n        NULL AS SYST_UV_Q,\n        NULL AS SYST_INS_Q,\n        NULL AS SYST_UPD_Q,\n        NULL AS SYST_DEL_Q,\n        NULL AS SYST_ET_TABL_M,\n        NULL AS SYST_UV_TABL_M,\n        NULL AS SYST_HEAD_ET_TABL_M,\n        NULL AS SYST_HEAD_UV_TABL_M,\n        NULL AS SYST_TRLR_ET_TABL_M,\n        NULL AS SYST_TRLR_UV_TABL_M,\n        NULL AS PREV_PROS_KEY_I,\n        NULL AS HEAD_RECD_TYPE_C,\n        NULL AS HEAD_FILE_M,\n        NULL AS HEAD_BTCH_RUN_D,\n        NULL AS HEAD_FILE_CRAT_S,\n        NULL AS HEAD_GENR_PRGM_M,\n        NULL AS HEAD_BTCH_KEY_I,\n        NULL AS HEAD_PROS_KEY_I,\n        NULL AS HEAD_PROS_PREV_KEY_I,\n        NULL AS TRLR_RECD_TYPE_C,\n        NULL AS TRLR_RECD_Q,\n        NULL AS TRLR_HASH_TOTL_A,\n        NULL AS TRLR_COLM_HASH_TOTL_M,\n        NULL AS TRLR_EROR_RECD_Q,\n        NULL AS TRLR_FILE_COMT_S,\n        NULL AS TRLR_RECD_ISRT_Q,\n        NULL AS TRLR_RECD_UPDT_Q,\n        NULL AS TRLR_RECD_DELT_Q\n    FROM util_parm PARM\n    CROSS JOIN calendar_dates DT\n)\n\nSELECT * FROM final",
  "metadata": {
    "models_used": [
      "claude-4-sonnet",
      "snowflake-llama-3.3-70b"
    ],
    "preferred_model": "claude-4-sonnet",
    "quality_score": 1.0,
    "dbt_features": [
      "config",
      "variables",
      "macros",
      "jinja_variables",
      "pre_hooks",
      "post_hooks",
      "tags",
      "tests"
    ],
    "total_time_ms": 31346,
    "comparison_notes": [
      "Selected claude-4-sonnet as preferred model",
      "claude-4-sonnet: Quality=1.000, Features=8, Time=16500ms",
      "snowflake-llama-3.3-70b: Quality=0.910, Features=9, Time=14831ms"
    ],
    "migration_notes": [
      "Organized logic using CTEs for better readability",
      "Added DBT configuration for materialization and metadata",
      "Used DBT variables for environment-specific configuration",
      "Converted from procedural BTEQ to declarative DBT model"
    ]
  },
  "warnings": [
    "Uses SELECT * - consider explicit column selection"
  ],
  "execution_time_ms": 31346
}
# LLM Response
Interaction ID: 20250821_154332_3ed05f89
Success: True
Processing Time: 11058ms
Quality Score: None

# Response
```sql
{%- set process_name = 'ACCT_BALN_BKDT_AUDT' -%}
{%- set stream_name = 'ACCT_BALN_BKDT_AUDT_STREAM' -%}

{{
  config(
    materialized='table',
    database=var('CAD_PROD_DATA'),
    schema=var('CAD_PROD_SCHEMA'),
    tags=['ACCT_BALN_BKDT_AUDT', 'AUDIT_TABLE'],
    pre_hook=[
        "{{ log_dcf_exec_msg('ACCT_BALN_BKDT_AUDT process started') }}"
    ],
    post_hook=[
        "{{ log_dcf_exec_msg('ACCT_BALN_BKDT_AUDT process ended') }}"
    ]
  )
}}

/*
    Model Documentation
    Purpose: Populate the AUDT table for future reference as the records 
             are going to be deleted from ACCT BALN BKDT and this acts as a driver for the 
             ADJ RULE view
    Business Logic: 
    Dependencies: 
        - ACCT_BALN_BKDT_STG1
        - ACCT_BALN_BKDT_ADJ_RULE
        - ACCT_BALN_BKDT_STG2
        - UTIL_PROS_ISAC
*/

WITH 
-- Capture the maximum pros_key_efft_i in the event of multiple pros keys for one account 
-- and populating for Auditing purposes
max_pros_key AS (
    SELECT 
        ACCT_I, 
        MAX(PROS_KEY_EFFT_I) AS PROS_KEY_EFFT_I
    FROM 
        {{ source('DDSTG', 'ACCT_BALN_BKDT_ADJ_RULE') }}
    GROUP BY 
        ACCT_I
),

-- Capture the latest pros key [from the parent process] and update the audt table
latest_bkdt_pros_key AS (
    SELECT 
        MAX(BKDT_PROS_KEY_I) AS BKDT_PROS_KEY_I
    FROM 
        {{ source('DDSTG', 'ACCT_BALN_BKDT_STG2') }}
),

-- Capture the latest pros key [from the Auditing process] and update the audt table
latest_pros_key AS (
    SELECT 
        MAX(PROS_KEY_I) AS PROS_KEY_EFFT_I
    FROM 
        {{ source('VTECH', 'UTIL_PROS_ISAC') }}
    WHERE 
        CONV_M = 'CAD_X01_ACCT_BALN_BKDT_AUDT'
),

-- Load the records from ACCT_BALN_BKDT_STG1 to ACCT_BALN_BKDT_AUDT
audt_data AS (
    SELECT 
        STG1.ACCT_I, 
        STG1.BALN_TYPE_C, 
        STG1.CALC_FUNC_C, 
        STG1.TIME_PERD_C, 
        STG1.BALN_A, 
        STG1.CALC_F, 
        STG1.SRCE_SYST_C, 
        STG1.ORIG_SRCE_SYST_C, 
        STG1.LOAD_D, 
        STG1.BKDT_EFFT_D, 
        STG1.BKDT_EXPY_D, 
        PKEY.PROS_KEY_EFFT_I, 
        STG1.PROS_KEY_EFFT_I AS ABAL_PROS_KEY_EFFT_I, 
        STG1.PROS_KEY_EXPY_I AS ABAL_PROS_KEY_EXPY_I, 
        STG2.BKDT_PROS_KEY_I AS ABAL_BKDT_PROS_KEY_I, 
        ADJ.PROS_KEY_EFFT_I AS ADJ_PROS_KEY_EFFT_I
    FROM 
        {{ source('DDSTG', 'ACCT_BALN_BKDT_STG1') }} STG1
    INNER JOIN 
        max_pros_key ADJ 
    ON 
        STG1.ACCT_I = ADJ.ACCT_I
    CROSS JOIN 
        latest_bkdt_pros_key STG2
    CROSS JOIN 
        latest_pros_key PKEY
)

SELECT 
    * 
FROM 
    audt_data
```